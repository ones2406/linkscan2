<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Lê Văn Linh (Cypher) — Profile</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="shortcut icon" href="https://scontent.fhan18-1.fna.fbcdn.net/v/t39.30808-6/557481975_122187746096569142_6613018808623610406_n.jpg?_nc_cat=102&ccb=1-7&_nc_sid=833d8c&_nc_ohc=pd93vMoULecQ7kNvwFdY8hT&_nc_oc=AdlmlfmUx7ViYSuDyxfqFGQUUUyJovbCmUNXXF2LR0QjQjQhUKTA2PxEmvE5uQrrytJtw&_nc_zt=23&_nc_ht=scontent.fhan18-1.fna&_nc_gid=XvYrDtqwNKIW7GSz0d8aCQ&oh=00_AffwcSnQZPTnX1284lJjcB2vJ6xZVeQhUXzZrBOpZ4pxXw&oe=6906B1FF">

    <style>
        /* CSS Variables */
        :root{
            --glass-bg: rgba(255,255,255,0.04);
            --card-bg: rgba(8,10,14,0.75);
            --accent: #00c4ff;
            --accent-2: #7c4dff;
            --text: #e9f1fb;
            --muted: #bfcbd8;
            --success: #4be27a;
            --toast-bg: rgba(0,0,0,0.75);
            --neon-strong: rgba(0,196,255,0.45);
        }

        /* Base Styles & Layout */
        *{box-sizing:border-box;margin:0;padding:0}
        html,body{height:100%}
        body{
            font-family:'Poppins',sans-serif;
            background: linear-gradient(270deg,#0f0c1a,#081024);
            color:var(--text);
            -webkit-font-smoothing:antialiased;
            overflow-y:auto;
        }
        .rgb-layer{position:fixed;inset:0;z-index:0;background: linear-gradient(270deg,rgba(124,77,255,0.4),rgba(0,196,255,0.4),rgba(0,255,170,0.35),rgba(255,85,150,0.35));background-size:900% 900%;filter:blur(28px) saturate(180%);pointer-events:none;animation: rgbFlow 9s linear infinite;mix-blend-mode:screen;opacity:1;}
        @keyframes rgbFlow{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
        .dark-overlay{position:fixed;inset:0;z-index:0;background:linear-gradient(180deg,rgba(0,0,0,0.55),rgba(2,6,12,0.8));pointer-events:none;}
        .wrap{position:relative;z-index:2;max-width:1000px;margin:36px auto;padding:24px}
        header{display:flex;gap:20px;align-items:center;background:rgba(255,255,255,0.03);border-radius:14px;padding:28px;box-shadow:0 8px 36px rgba(2,6,12,0.7);backdrop-filter:blur(10px)}
        .avatar{width:110px;height:110px;border-radius:50%;flex:0 0 110px;background-size:cover;background-position:center;box-shadow:0 0 25px rgba(0,196,255,0.3)}
        header h1{font-size:1.6rem;color:var(--text);margin-bottom:6px}
        header p{color:var(--muted);font-size:0.98rem}
        .grid{display:grid;grid-template-columns:1fr 360px;gap:20px;margin-top:20px}
        .card{background:var(--card-bg);border-radius:12px;padding:20px;box-shadow:0 6px 30px rgba(2,6,12,0.6)}
        .card h2{color:var(--accent);margin-bottom:10px}
        .lead{color:var(--muted);line-height:1.6;margin-bottom:14px}
        .services{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
        .service-item{background:rgba(255,255,255,0.03);padding:8px 12px;border-radius:999px;font-size:0.92rem;color:var(--muted);border:1px solid rgba(255,255,255,0.05);transition:.2s}
        .service-item:hover{color:var(--text);transform:translateY(-5px);box-shadow:0 10px 25px rgba(0,196,255,0.1);border-color:var(--neon-strong)}
        .panel{background:rgba(255,255,255,0.03);border-radius:12px;padding:18px;display:flex;flex-direction:column;align-items:center;gap:12px}
        .panel h3{color:var(--accent)}
        .qr{width:190px;height:190px;border-radius:12px;border:3px solid rgba(255,255,255,0.05);box-shadow:0 0 40px rgba(0,196,255,0.25)}
        .qr-wrap{position:relative}
        .qr-wrap::after{content:"";position:absolute;inset:-12px;border-radius:16px;background:conic-gradient(from 0deg,rgba(0,196,255,0.4),rgba(124,77,255,0.35));filter:blur(16px);animation:spin 8s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
        .bank-info{width:100%;margin-top:8px}
        .bank-row{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:10px;margin:6px 0;background:rgba(255,255,255,0.02);cursor:pointer;transition:.2s}
        .bank-row:hover{background:rgba(0,196,255,0.08)}
        .label{color:var(--muted);font-size:0.92rem}
        .value{color:var(--text);font-weight:700}
        .hint{font-size:0.82rem;color:var(--muted);margin-top:6px;text-align:center}
        .links{display:flex;gap:10px;margin-top:12px}
        .social{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.05);color:var(--text);text-decoration:none;transition:.2s;font-weight:600}
        .social:hover{background:rgba(0,196,255,0.1);transform:translateY(-4px)}
        .donate{margin-top:10px;padding:10px 16px;border-radius:10px;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#041225;font-weight:700;text-decoration:none;text-align:center;transition:.2s;width:100%;}
        .donate:hover{filter:brightness(1.1);transform:translateY(-2px)}
        .webs{display:flex;flex-wrap:wrap;gap:12px;margin-top:12px}
        .web-card{flex:0 0 calc(50% - 12px);background:rgba(255,255,255,0.02);border-radius:12px;padding:12px;display:flex;align-items:center;gap:10px;transition:.2s;border:1px solid rgba(255,255,255,0.05)}
        .web-card:hover{transform:translateY(-6px);border-color:var(--neon-strong);box-shadow:0 0 20px rgba(0,196,255,0.08)}
        .web-card img{width:40px;height:40px;border-radius:10px;box-shadow:0 0 12px rgba(0,196,255,0.3)}
        .title{font-weight:700;color:var(--text)}
        .desc{color:var(--muted);font-size:0.85rem}
        
        /* FORM & COMMENT STYLES */
        .comment-area{width:100%; margin-top: 20px; border-top: 1px solid rgba(255,255,255,0.05); padding-top: 20px;}
        .comment-area p{color:var(--muted); font-size: 0.85rem; margin-bottom: 10px;}
        .comment-input-group{display: flex; gap: 8px; margin-bottom: 15px;}
        .comment-input-group input[type="text"]{
            flex-grow: 1; padding: 10px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.1); 
            background: rgba(0,0,0,0.5); color: var(--text); outline: none;
        }
        .comment-input-group button{
            padding: 10px 15px; background: var(--accent-2); color: var(--text); 
            font-weight: 600; border: none; border-radius: 6px; cursor: pointer; transition:.2s;
        }
        .comment-input-group button:hover{filter: brightness(1.2);}
        .comment-list-title{color:var(--muted); margin-bottom: 8px; font-weight: 600;}
        #commentList li {
            padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.08); 
            margin-bottom: 5px; font-size: 0.95rem;
        }
        #commentList li:last-child { border-bottom: none; }
        .comment-meta{display:flex; align-items:center; gap:8px;}
        .comment-meta img{width:24px;height:24px;border-radius:50%;}
        .comment-meta strong{color:var(--accent); font-weight: 700;}
        .comment-text{color:var(--text); flex-grow: 1;}
        .comment-time{color:var(--muted);display:block;text-align:right; font-size: 0.75rem;}

        /* TOAST */
        .toast{position:fixed;right:20px;bottom:24px;padding:12px 16px;border-radius:10px;background:var(--toast-bg);color:var(--text);box-shadow:0 8px 30px rgba(0,0,0,0.6);display:none;font-weight:700;z-index: 10000;}
        .toast.show{display:flex;animation:fade .3s ease both}
        @keyframes fade{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

        /* Chatbot CSS */
        #cypher-toggle { position: fixed; bottom: 24px; right: 24px; width:56px; height:56px; border-radius:50%; background: linear-gradient(135deg,#00c6ff,#0072ff); color:#fff; border:none; z-index:10050; cursor:pointer; box-shadow:0 8px 30px rgba(0,0,0,0.35); display:flex; align-items:center; justify-content:center; font-size:22px; transition: transform 0.3s ease; }
        #cypher-toggle:hover { transform: scale(1.05); }
        #cypher-panel { position: fixed; bottom: 96px; right: 24px; width:360px; max-height:520px; background:#0b1220; border-radius:14px; box-shadow:0 12px 40px rgba(0,0,0,0.6); display:none; flex-direction:column; overflow:hidden; z-index:10040; border:1px solid rgba(0,198,255,0.12); }
        #cypher-header { padding:12px 14px; font-weight:700; color:#fff; background:linear-gradient(90deg,#00c6ff22,#0072ff22); }
        #cypher-messages { flex:1; padding:12px; overflow-y:auto; font-size:14px; color:#e6eef8; background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent); }
        .cy-msg { display:inline-block; padding:8px 12px; border-radius:12px; margin:6px 0; max-width:80%; word-wrap:break-word; }
        .cy-user { background:linear-gradient(90deg,#0072ff,#00c6ff); color:#001827; align-self:flex-end; float:right; border-bottom-right-radius:4px; }
        .cy-bot { background:#0f1720; color:#e6eef8; align-self:flex-start; float:left; border-bottom-left-radius:4px; }
        #cypher-input { display:flex; gap:8px; padding:10px; border-top:1px solid rgba(255,255,255,0.02); background:rgba(0,0,0,0.2); }
        #cypher-input input { flex:1; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.03); background:#07101a; color:#fff; outline:none; font-size: 14px; }
        #cypher-input button { padding:10px 14px; border-radius:8px; border:none; background:#00c6ff; color:#012; cursor:pointer; font-weight:700; transition: background-color 0.2s; }
        #cypher-input button:hover { background: #4ccfff; }
        .clearfix::after { content:""; display:block; clear:both; }

        /* Footer & Media Queries */
        footer{margin-top:26px;text-align:center;color:var(--muted);font-size:0.9rem;padding-bottom:40px}
        @media(max-width:980px){.grid{grid-template-columns:1fr}.panel{order:-1}.web-card{flex:0 0 100%}}
    </style>
</head>
<body>

    <div class="rgb-layer"></div>
    <div class="dark-overlay"></div>

    <div class="wrap">

        <header>
            <div class="avatar" style="background-image:url('https://scontent.fhan18-1.fna.fbcdn.net/v/t39.30808-1/571658413_122191948142569142_1978419823035286129_n.jpg?stp=cp6_dst-jpg_s160x160_tt6&_nc_cat=106&ccb=1-7&_nc_sid=e99d92&_nc_ohc=ANoqFd1Bzr8Q7kNvwGebFtl&_nc_oc=AdnVPq-fARWXz0MW5plWyujBiywRAENDFvZbsvw4qqrD_v1Kzv679LNzIIqRWdfHab0&_nc_zt=24&_nc_ht=scontent.fhan18-1.fna&_nc_gid=EvlJLEkJS4ie69Ah9a7Tnw&oh=00_Afdw1B88bZmt-Oosuu8MQ2XuOKP1_9taRWLKBzDp4x2R_A&oe=69093542');"></div>
            <div class="meta">
                <h1>Lê Văn Linh (Cypher)</h1>
                <p>Admin website <a href="https://cypher234.shop" target="_blank" style="color:var(--accent);text-decoration:underline">Cypher234.shop</a></p>
            </div>
        </header>

        <div class="grid">

            <div class="card">
                <h2>Giới thiệu bản thân</h2>
                <p class="lead">Xin chào! Tôi là <strong>Lê Văn Linh</strong>, chuyên cung cấp các dịch vụ game và thiết kế web. Uy tín, an toàn và chất lượng là ưu tiên hàng đầu.</p>

                <h2>Dịch vụ</h2>
                <div class="services">
                    <span class="service-item">Tạo shop game siêu tốc giá rẻ</span>
                    <span class="service-item">Cung cấp dịch vụ trực tuyến điện tử giải trí</span>
                    <span class="service-item">Tư vấn thương hiệu cá nhân</span>
                    <span class="service-item">Tối ưu SEO & Marketing</span>
                    <span class="service-item">Cung cấp tài khoản ảo về game Liên Quân Mobile giải trí trực tuyến</span>
                </div>

                <h2 style="margin-top:18px">Thanh toán nhanh (VietQR)</h2>
                <div class="panel">
                    <div class="qr-wrap"><img class="qr" src="https://img.vietqr.io/image/970407-19073015796012-compact.png?addInfo=LE%20VAN%20LINH"></div>

                    <div class="bank-info">
                        <div class="bank-row copy-target" data-copy-text="Techcombank"><div class="label">Ngân hàng</div><div class="value">Techcombank</div></div>
                        <div class="bank-row copy-target" data-copy-text="19073015796012"><div class="label">Số tài khoản</div><div class="value">19073015796012</div></div>
                        <div class="bank-row copy-target" data-copy-text="LÊ VĂN LINH"><div class="label">Chủ tài khoản</div><div class="value">LÊ VĂN LINH</div></div>
                        <div class="hint">Nhấn vào để sao chép thông tin.</div>
                    </div>

                    <div class="links">
                        <a class="social" href="https://zalo.me/0366241530" target="_blank">Zalo Chat</a>
                        <a class="social" href="https://www.facebook.com/onessz26/" target="_blank">Facebook</a>
                    </div>

                    <a class="donate" href="https://vietqr.co/api/generate/tcb/19073015796012/LE%20VAN%20LINH" target="_blank">Donate / Hỗ trợ</a>
                </div>
            </div>

            <aside class="panel">
                <h3>🌐 Trang Web Của Tôi</h3>
                <div class="webs">
                    <a class="web-card" href="https://cypher234.shop" target="_blank">
                        <img src="https://scontent.fhan18-1.fna.fbcdn.net/v/t39.30808-6/557481975_122187746096569142_6613018808623610406_n.jpg?_nc_cat=102&ccb=1-7&_nc_sid=833d8c&_nc_ohc=IzFaUQVgL6wQ7kNvwE_oYhk&_nc_oc=AdkQPUJ3VbjgpT1RXpILG-CbmsBvKq69wCYhHsgEJ1PIl5w1pmM1TqtEhHNA5ehxjC4&_nc_zt=23&_nc_ht=scontent.fhan18-1.fna&_nc_gid=lrNwn1zbnQfwyu--n5n8eQ&oh=00_AfeMlx0mXSJabdsz2RIqpgDDQZYggjf2bo04bZT4rGeBQw&oe=690A35FF">
                        <div><div class="title">Cypher234.shop</div><div class="desc">Random 9 cá 100% ra 3s</div></div>
                    </a>
                </div>
                
                <div class="comment-area">
                    <button id="loginBtn" style="padding: 10px 15px; background: var(--accent); color: #041225; font-weight: 700; border: none; border-radius: 8px; cursor: pointer; width: 100%; margin-bottom: 15px;">Đăng nhập bằng Google</button>
                    <button id="logoutBtn" style="padding: 10px 15px; background: var(--accent-2); color: #fff; font-weight: 700; border: none; border-radius: 8px; cursor: pointer; width: 100%; display: none; margin-bottom: 15px;">Đăng xuất</button>

                    <div id="comment-section">
                        <h3 style="color:var(--text); margin-bottom: 10px;">Bình luận</h3>
                        <p>Lưu Ý : Mỗi người chỉ được bình luận 1 lần không thể sửa hay xóa.</p>
                        <div class="comment-input-group">
                            <input type="text" id="commentInput" placeholder="Vui lòng đăng nhập..." disabled>
                            <button id="sendComment" disabled>Gửi</button>
                        </div>

                        <h4 class="comment-list-title">Danh sách bình luận:</h4>
                        <ul id="commentList" style="list-style-type: none; padding: 0;"></ul>
                    </div>
                </div>
            </aside>
        </div>

        <footer>© 2025 LÊ VĂN LINH — Thiết kế &amp; Hỗ trợ: Cypher</footer>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        /** Sao chép văn bản và hiển thị toast. */
        function copyText(text){
            navigator.clipboard.writeText(text).then(()=>{
                showToast('✅ Đã sao chép: ' + text);
            }).catch(err => {
                console.error('Không thể sao chép văn bản: ', err);
                showToast('❌ Lỗi sao chép.');
            });
        }

        /** Hiển thị thông báo Toast. */
        function showToast(msg){
            const t=document.getElementById('toast');
            t.textContent=msg;
            t.classList.add('show');
            clearTimeout(window._tt);
            window._tt=setTimeout(()=>t.classList.remove('show'),2200);
        }

        // Gán sự kiện cho các hàng ngân hàng
        document.querySelectorAll('.copy-target').forEach(row => {
            row.addEventListener('click', function() {
                copyText(this.getAttribute('data-copy-text'));
            });
        });
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut 
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { 
            getFirestore, collection, addDoc, getDocs, query, orderBy, where, serverTimestamp
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // === 1. Cấu hình Firebase ===
        const firebaseConfig = {
            apiKey: "AIzaSyCb3sLxKk8_l6UT3hfcy_JXOs33bQrWb60",
            authDomain: "cypherdev-21611.firebaseapp.com",
            projectId: "cypherdev-21611",
            storageBucket: "cypherdev-21611.firebasestorage.app",
            messagingSenderId: "108470103585",
            appId: "1:108470103585:web:98b72f0513d2af55087d60",
            measurementId: "G-CD1R2G24E2"
        };

        // === 2. Khởi tạo Firebase ===
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();
        const db = getFirestore(app);
        const commentsRef = collection(db, "comments");

        // === 3. Lấy phần tử HTML ===
        const loginBtn = document.getElementById("loginBtn");
        const logoutBtn = document.getElementById("logoutBtn");
        const commentInput = document.getElementById("commentInput");
        const sendCommentBtn = document.getElementById("sendComment");
        const commentList = document.getElementById("commentList");
        const toastElement = document.getElementById("toast"); 

        let currentUser = null;
        let hasCommented = false; 
        let isLoadingComments = false; // ✅ BIẾN CỜ MỚI ĐỂ CHẶN TẢI TRÙNG LẶP

        // === 9. Toast helper ===
        function showToast(msg) {
            // Sử dụng hàm showToast đã định nghĩa ở global scope
            if (window.showToast) {
                window.showToast(msg);
            } else {
                console.warn("Không tìm thấy global showToast function.");
            }
        }
        
        // Hàm kiểm tra user đã bình luận chưa
        async function checkIfUserCommented(uid) {
            try {
                const q = query(commentsRef, where("uid", "==", uid));
                const snapshot = await getDocs(q);
                return !snapshot.empty;
            } catch (e) {
                console.error("Lỗi kiểm tra bình luận:", e);
                return false; 
            }
        }
        
        // === 8. Tải bình luận (Đã FIX lỗi lặp bằng cờ) ===
        async function loadComments() {
            // 🛑 CHẶN NẾU ĐANG TẢI
            if (isLoadingComments) {
                console.log("Đang tải bình luận, bỏ qua lệnh tải trùng lặp.");
                return;
            }
            isLoadingComments = true; // Bật cờ
            
            // ✅ XÓA NỘI DUNG CŨ NGAY LẬP TỨC
            commentList.innerHTML = "<li style='color:var(--muted); text-align:center;'>Đang tải bình luận...</li>"; 
            
            try {
                const q = query(commentsRef, orderBy("timestamp", "desc"));
                const snapshot = await getDocs(q);
                
                // Xóa placeholder "Đang tải..."
                commentList.innerHTML = "";
                
                if (snapshot.empty) {
                     commentList.innerHTML = "<li style='color:var(--muted); text-align:center;'>Chưa có bình luận nào.</li>";
                     return;
                }
                
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const li = document.createElement("li");
                    
                    let timeDisplay = '';
                    if (data.timestamp && typeof data.timestamp.toDate === 'function') {
                        const date = data.timestamp.toDate();
                        timeDisplay = `${date.toLocaleTimeString("vi-VN")} ${date.toLocaleDateString("vi-VN")}`;
                    } else {
                        timeDisplay = 'Đang cập nhật...'; 
                    }
                    
                    // Thêm class 'comment-text' vào nội dung bình luận để khớp với CSS
                    li.innerHTML = `
                        <div class="comment-meta">
                            <img src="${data.photoURL || 'https://upload.wikimedia.org/wikipedia/commons/7/7c/Profile_avatar_placeholder_large.png'}" alt="Avatar">
                            <strong>${data.username}</strong>
                        </div>
                        <span class="comment-text">${data.comment}</span>
                        <small class="comment-time">${timeDisplay}</small>`;

                    commentList.appendChild(li);
                });
            } catch (e) {
                console.error("Lỗi khi tải bình luận:", e);
                commentList.innerHTML = "<li style='color:red;'>Không thể tải bình luận.</li>";
            } finally {
                isLoadingComments = false; // Tắt cờ sau khi hoàn thành (thành công hoặc thất bại)
            }
        }

        // === 6. Theo dõi trạng thái đăng nhập ===
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                loginBtn.style.display = "none";
                logoutBtn.style.display = "block";
                
                checkIfUserCommented(user.uid).then(commented => {
                    hasCommented = commented;
                    if (hasCommented) {
                        commentInput.disabled = true;
                        sendCommentBtn.disabled = true;
                        commentInput.placeholder = "Bạn đã bình luận một lần.";
                    } else {
                        commentInput.disabled = false;
                        sendCommentBtn.disabled = false;
                        commentInput.placeholder = "Nhập bình luận...";
                    }
                });
                // Chỉ gọi loadComments một lần
                loadComments(); 
            } else {
                currentUser = null;
                hasCommented = false; 
                loginBtn.style.display = "block";
                logoutBtn.style.display = "none";
                sendCommentBtn.disabled = true;
                commentInput.disabled = true;
                commentInput.placeholder = "Vui lòng đăng nhập để bình luận.";
                // Chỉ gọi loadComments một lần
                loadComments();
            }
        });
        
        // === 4. Đăng nhập Google ===
        loginBtn.addEventListener("click", async () => {
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Lỗi đăng nhập:", error);
                showToast("❌ Đăng nhập thất bại.");
            }
        });

        // === 5. Đăng xuất ===
        logoutBtn.addEventListener("click", async () => {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Lỗi đăng xuất:", error);
                showToast("❌ Lỗi khi đăng xuất.");
            }
        });


        // === 7. Gửi bình luận (mỗi tài khoản chỉ 1 lần) ===
        sendCommentBtn.addEventListener("click", async () => {
            if (!currentUser || hasCommented) {
                showToast("⚠️ Bạn không thể bình luận lúc này.");
                return;
            }

            const text = commentInput.value.trim();
            if (!text) {
                showToast("⚠️ Bình luận không được để trống.");
                return;
            }

            sendCommentBtn.disabled = true;
            commentInput.disabled = true;

            try {
                await addDoc(commentsRef, {
                    uid: currentUser.uid,
                    username: currentUser.displayName || "Ẩn danh",
                    photoURL: currentUser.photoURL || "https://upload.wikimedia.org/wikipedia/commons/7/7c/Profile_avatar_placeholder_large.png", 
                    comment: text,
                    timestamp: serverTimestamp()
                });

                commentInput.value = "";
                hasCommented = true; 
                commentInput.placeholder = "Bạn đã bình luận một lần.";
                showToast("✅ Bình luận đã được gửi!");
                
                // Tải lại bình luận sau khi gửi
                loadComments(); 
            } catch (e) {
                console.error("Lỗi gửi bình luận:", e);
                showToast("❌ Gửi bình luận thất bại.");
                commentInput.disabled = false;
                sendCommentBtn.disabled = false;
            }
        });
        
        // Tải bình luận lần đầu (chắc chắn chạy)
        loadComments(); 
    </script>
    
    <button id="cypher-toggle" aria-label="Open chat">💬</button>

    <div id="cypher-panel" role="dialog" aria-label="Cypher AI Chat">
        <div id="cypher-header">🤖 Cypher AI — Hỗ trợ</div>
        <div id="cypher-messages" class="clearfix" aria-live="polite"></div>
        <div id="cypher-input">
            <input id="cypher-text" placeholder="Viết gì đó..." />
            <button id="cypher-send">Gửi</button>
        </div>
    </div>

    <script>
    (function(){
        // ** ĐƯỜNG DẪN PROXY (Vẫn là 404 nếu file proxy.php không tồn tại trên server cypher234.shop) **
        const PROXY_URL = "https://cypher234.shop/public/proxy.php"; 

        const toggle = document.getElementById("cypher-toggle");
        const panel = document.getElementById("cypher-panel");
        const msgBox = document.getElementById("cypher-messages");
        const input = document.getElementById("cypher-text");
        const sendBtn = document.getElementById("cypher-send");
        
        // FIX LỖI "TypeError: Cannot set properties of null..."
        if (!toggle || !panel || !msgBox || !input || !sendBtn) {
            console.error("Lỗi khởi tạo Chatbot: Một số phần tử HTML không được tìm thấy. Bỏ qua logic Chatbot.");
            return; 
        }

        // Toggle open/close
        toggle.addEventListener("click", () => {
            panel.style.display = panel.style.display === "flex" ? "none" : "flex";
            if (panel.style.display === "flex") {
                input.focus();
                if (msgBox.children.length === 0) {
                    append("Xin chào! Tôi là AI Cypher, tôi có thể giúp gì cho bạn? Hãy hỏi về dịch vụ của Linh nhé.", "cy-bot");
                }
            }
        });

        // Send on click or Enter
        sendBtn.addEventListener("click", sendMessage);
        input.addEventListener("keypress", (e) => { 
            if (e.key === "Enter") {
                e.preventDefault(); 
                sendMessage();
            }
        });

        // Utility: append message
        function append(text, cls) {
            const wrapper = document.createElement("div");
            wrapper.className = "clearfix"; 
            
            const d = document.createElement("div");
            d.className = "cy-msg " + (cls || "cy-bot");
            d.innerText = text;
            
            wrapper.appendChild(d);
            msgBox.appendChild(wrapper);
            
            msgBox.scrollTop = msgBox.scrollHeight;
        }

        // Send message handler
        let isWaiting = false;
        async function sendMessage() {
            if (isWaiting) return; 
            const t = input.value.trim();
            if (!t) return;
            
            append(t, "cy-user");
            input.value = "";
            append("⏳ Đang xử lý...", "cy-bot");
            isWaiting = true;
            input.disabled = true;
            sendBtn.disabled = true;

            try {
                const res = await fetch(PROXY_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ inputs: t })
                });

                // Xóa tin nhắn trạng thái "Đang xử lý..."
                const statusNodes = Array.from(msgBox.querySelectorAll(".cy-msg.cy-bot")).filter(n => n.innerText.includes("Đang xử lý"));
                statusNodes.forEach(n => n.parentElement.remove()); 

                if (!res.ok) {
                    // Cải thiện thông báo lỗi HTTP
                    throw new Error(`API trả về Lỗi HTTP ${res.status}. Vui lòng kiểm tra file proxy.php.`);
                }

                const text = await res.text();
                let data;
                try { data = JSON.parse(text); } catch(e) { data = text; }

                let reply = "Xin lỗi, đã xảy ra lỗi trong quá trình xử lý phản hồi từ AI.";
                
                if (Array.isArray(data) && data[0] && data[0].generated_text !== undefined) {
                    reply = data[0].generated_text.trim() || "Tôi không hiểu, bạn có thể diễn đạt lại không?";
                } else if (data && typeof data === "object" && data.error) {
                    reply = "Lỗi AI: " + data.error;
                } else if (typeof data === "string") {
                    reply = data; 
                } else {
                    reply = JSON.stringify(data);
                }
                
                if (reply.startsWith(t)) {
                    reply = reply.substring(t.length).trim();
                }
                
                append(reply, "cy-bot");
                
            } catch (err) {
                // Xóa tin nhắn trạng thái "Đang xử lý..." lần nữa
                const statusNodes = Array.from(msgBox.querySelectorAll(".cy-msg.cy-bot")).filter(n => n.innerText.includes("Đang xử lý"));
                statusNodes.forEach(n => n.parentElement.remove()); 

                // Hiển thị lỗi ra giao diện
                append(`⚠️ Lỗi kết nối server: ${err.message}.`, "cy-bot");
                console.error("Chat proxy error:", err);
            } finally {
                isWaiting = false;
                input.disabled = false;
                sendBtn.disabled = false;
                input.focus();
            }
        }

        // Accessibility: close panel on Escape
        document.addEventListener("keydown", e => { 
            if (e.key === "Escape") panel.style.display = "none"; 
        });

    })();
    </script>
</body>
</html>
